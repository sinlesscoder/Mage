from sqlalchemy import create_engine
from load_mongodb import retrieve_mongo_connection


if 'data_exporter' not in globals():
    from mage_ai.data_preparation.decorators import data_exporter


# Helper Function: Connecting to Mongo
def retrieve_mongo_connection(search_term: str, uri='104.225.217.176:8363'):
    """
    Inputs:
        - search_term (string): Search term for the query of API
        - uri (string): Uniform Resource Identifier to represent MongoDB server
    
    Output:
        - collection_name (Mongo.Collection): Collection to store your results.
    """
    # Set up a Mongo Client
    client = MongoClient(uri)

    # Select a database
    database = client['aliexpress_items']

    # Select a collection
    collection_name = database[search_term]

    return collection_name

# Prepare Data
def prepare_data_mongo(search_term: str, api_result: dict):
    """
    Inputs:
        - search_term (string): Search query for item information
    Output:
        - result_dict (dictionary): Dictionary containing key, 
            values of page number mapped to actual JSON result
    """
    # Get results
    results = api_result[search_term]

    return results

def db_load(search_term: str):
    """
    Inputs:
        - search_term (string)
    Output:
        - result_dict (dictionary): Dictionary containing results
            with pages as keys
    """
    # Get the Mongo collection
    collection_name = retrieve_mongo_connection(search_term)

    # Get the result dictionary
    result_dict = prepare_data_mongo(search_term)

    # Getting current date time as a string
    result_dict['updated_at'] = str(datetime.now())

    # Insert the Dictionary as an Object in the MongoDB Collection
    collection_name.insert_one(result_dict)

    return result_dict


@data_exporter
def export_data(data, *args, **kwargs):
    """
    Exports data to some source

    Args:
        args: The input variables from upstream blocks

    Output (optional):
        Optionally return any object and it'll be logged and
        displayed when inspecting the block run.
    """
    # Specify your data exporting logic here

    # Connection object
    cursor = postgres_connection().connect()
    
    # Loading as a SQL table in Postgres server
    data.to_sql('aliexpress_results', con=cursor, index=False, if_exists='replace')



